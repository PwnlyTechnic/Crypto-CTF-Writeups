import requests

hexchars = "0123456789abcdef"

def xor(s1, s2):
    res = [chr(ord(i) ^ ord(j)) for i, j in zip(s1, s2)]
    return "".join(res)

def get_cookie(request_obj):
    cookie_list = []
    for cookie in request_obj.cookies:
        cookie_list.append(cookie.value)
    return cookie_list

def test_cookie(cookie_val):
    f = open("data.txt","w")
    _len = len(cookie_val.decode("hex"))
    def_flip = "b2"
    for i in range(_len):
        send_cookie_val = cookie_val[0:i-1] + def_flip + cookie_val[i+1:]
        f.write("Default cookie: " + cookie_val + "\n")
        f.write("Sending cookie: " + send_cookie_val + "\n")
        print "i: ", i
        print "Default cookie: " + cookie_val
        print "Sending cookie: " + send_cookie_val
        temp = send_cookie(send_cookie_val)
        print temp
        f.write(temp + "\n")
        f.write("\n\n")
        print "\n"


def send_cookie(cookie_val):
    for i in cookie_val:
        assert i in hexchars
    session_cookie = {"session": cookie_val}
    re = requests.get("http://185.168.131.153/", cookies=session_cookie)
    return re.text

def chunks(inputstr, blocksize):
    list1 = []
    for i in range(0, len(inputstr), blocksize):
        list1.append(inputstr[i:i+blocksize])
    return list1


re = requests.get("http://185.168.131.153/")
cookie_val = get_cookie(re)[0]
print "Request cookie values: ", cookie_val
print "Length of cookie in hex decoded form: ", len(cookie_val.decode("hex"))
print "Text for request: ", send_cookie(cookie_val)

print "\n"

def process(string1, p1, p2):
    return xor(xor(string1.decode("hex"), p1), p2).encode("hex")

send_corrupt_cookie = cookie_val[0:32] + cookie_val[32:64] + process(cookie_val[64:96], "lse}\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c","ue}\r\r\r\r\r\r\r\r\r\r\r\r\r") + cookie_val[96:]
recv_str = send_cookie(send_corrupt_cookie)
recv_str = recv_str[120:-42].decode("hex")
flip1 = recv_str[16:32]

print "\n"

send_corrupt_cookie = cookie_val[0:32] + process(cookie_val[32:64], flip1, 'in","isAdmin":tr') + process(cookie_val[64:96], "lse}\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c","ue}\r\r\r\r\r\r\r\r\r\r\r\r\r") + cookie_val[96:]
recv_str = send_cookie(send_corrupt_cookie)
recv_str = recv_str[120:-42].decode("hex")
flip2 = recv_str[:16]

send_corrupt_cookie = process(cookie_val[0:32], flip2, '{"username":"adm') + process(cookie_val[32:64], flip1, 'in","isAdmin":tr') + process(cookie_val[64:96], "lse}\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c\x0c","ue}\r\r\r\r\r\r\r\r\r\r\r\r\r") + cookie_val[96:]
print send_cookie(send_corrupt_cookie)
